<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÄÄƒng nháº­p</title>
    <link rel="stylesheet" href="account.css" />
</head>

<body>
    <div class="glass-container">
        <h2>ÄÄ‚NG NHáº¬P</h2>
        <form id="loginForm">
            <div class="input-group">
                <input type="text" id="username" required />
                <label>TÃªn Ä‘Äƒng nháº­p (Email hoáº·c SÄT)</label>
            </div>
            <div class="input-group">
                <input type="password" id="password" required />
                <label>Máº­t kháº©u</label>
            </div>
            <div class="remember-forgot">
                <label><input type="checkbox" /> Ghi nhá»› tÃ´i</label>
                <a href="forgot.html">QuÃªn máº­t kháº©u?</a>
            </div>
            <button type="submit" class="login-btn">ÄÄƒng nháº­p</button>
            <br /><br />
            <div class="register-link">
                ChÆ°a cÃ³ tÃ i khoáº£n? <a href="register.html">ÄÄƒng kÃ½</a>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = "https://localhost:7076/api";

        document.getElementById("loginForm").addEventListener("submit", async(e) => {
            e.preventDefault();

            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value;
            const loginBtn = document.querySelector(".login-btn");

            if (!username || !password) {
                alert("âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tÃ i khoáº£n vÃ  máº­t kháº©u!");
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = "Äang Ä‘Äƒng nháº­p...";

            try {
                // Gá»i API login
                const response = await fetch(
                    `${API_BASE}/Taikhoans/DangNhap?emailorsdt=${encodeURIComponent(username)}&matkhau=${encodeURIComponent(password)}`, {
                        method: "POST"
                    }
                );

                // Äá»c response má»™t láº§n duy nháº¥t
                const responseText = await response.text();
                let result;

                try {
                    // Thá»­ parse JSON trÆ°á»›c
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    // Náº¿u khÃ´ng parse Ä‘Æ°á»£c JSON, táº¡o object tá»« text
                    console.log("ğŸ“¡ Response text:", responseText);

                    if (responseText.includes("BCrypt") || responseText.includes("Exception")) {
                        result = {
                            message: "Lá»—i há»‡ thá»‘ng: Váº¥n Ä‘á» vá»›i mÃ£ hÃ³a máº­t kháº©u. Vui lÃ²ng liÃªn há»‡ admin."
                        };
                    } else {
                        result = {
                            message: responseText || "Lá»—i server khÃ´ng xÃ¡c Ä‘á»‹nh"
                        };
                    }
                }

                console.log("ğŸ“¡ Káº¿t quáº£ API:", result);

                if (!response.ok) {
                    alert(result.message || "TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!");
                    loginBtn.disabled = false;
                    loginBtn.textContent = "ÄÄƒng nháº­p";
                    return;
                }

                // âœ… XÃ¡c Ä‘á»‹nh loáº¡i tÃ i khoáº£n
                let role = result.role ? result.role.toLowerCase() : "customer";
                let name = result.hoten || result.Hoten || result.name || "NgÆ°á»i dÃ¹ng";
                let redirect = "home.html";

                if (role === "admin") redirect = "admin-dashboard.html";
                else if (role === "receptionist" || role === "manager") redirect = "letan/letan_dashboard.html";

                // âœ… LÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng
                const userData = {
                    id: result.makh || result.manv || null,
                    name,
                    email: result.email || username,
                    sdt: result.sdt || result.Sdt || null,
                    role,
                    loginTime: new Date().toISOString(),
                };

                localStorage.setItem("currentUser", JSON.stringify(userData));
                alert(`âœ… Xin chÃ o ${name}!`);
                window.location.href = redirect;
            } catch (error) {
                console.error("âŒ Lá»—i khi Ä‘Äƒng nháº­p:", error);
                alert("KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server. Vui lÃ²ng kiá»ƒm tra láº¡i!");
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "ÄÄƒng nháº­p";
            }
        });

        // ğŸ”’ Náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p â†’ tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng
        window.onload = function() {
            const currentUser = localStorage.getItem("currentUser");
            if (currentUser) {
                const user = JSON.parse(currentUser);
                if (user.role === "admin") window.location.href = "admin-dashboard.html";
                else if (user.role === "receptionist" || user.role === "manager")
                    window.location.href = "letan/letan_dashboard.html";
                else window.location.href = "home.html";
            }
        };
    </script>
</body>

</html>