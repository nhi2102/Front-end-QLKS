<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ thanh to√°n - Thanh Tr√† Hotel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="footer.css">
    <style>
        .payment-result-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 40px;
            text-align: center;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .result-icon.success {
            color: #28a745;
        }
        
        .result-icon.error {
            color: #dc3545;
        }
        
        .result-title {
            font-size: 28px;
            margin-bottom: 15px;
            color: #112173;
        }
        
        .result-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .result-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #333;
        }
        
        .detail-value {
            color: #666;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #112173;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d1a5c;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>

<body>
    <div id="header-placeholder"></div>

    <div class="payment-result-container">
        <div id="result-content">
            <div class="result-icon">‚è≥</div>
            <h1 class="result-title">ƒêang x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n...</h1>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="script.js"></script>
    <script>
        const API_BASE = 'https://localhost:7076/api';
        
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const vnp_ResponseCode = urlParams.get('vnp_ResponseCode');
            const vnp_TxnRef = urlParams.get('vnp_TxnRef');
            const vnp_OrderInfo = urlParams.get('vnp_OrderInfo');
            const vnp_Amount = urlParams.get('vnp_Amount');
            const vnp_TransactionNo = urlParams.get('vnp_TransactionNo');
            const vnp_PayDate = urlParams.get('vnp_PayDate');

            const resultContent = document.getElementById('result-content');

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n v√†o database
            if (vnp_TxnRef) {
                const maDatPhong = parseInt(vnp_TxnRef);
                console.log('üîÑ C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n cho ƒë·∫∑t ph√≤ng:', maDatPhong);
                
                try {
                    if (vnp_ResponseCode === '00') {
                        // Thanh to√°n th√†nh c√¥ng ‚Üí C·∫≠p nh·∫≠t tr·∫°ng th√°i
                        await updatePaymentStatus(maDatPhong, 'ƒê√£ thanh to√°n', 'ƒê√£ ƒë·∫∑t');
                        console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t: Trangthaithanhtoan = ƒê√£ thanh to√°n');
                    } else {
                        // Thanh to√°n th·∫•t b·∫°i ‚Üí H·ªßy ƒë·∫∑t ph√≤ng
                        await updatePaymentStatus(maDatPhong, 'Ch∆∞a thanh to√°n', 'ƒê√£ h·ªßy');
                        console.log('‚ùå ƒê√£ c·∫≠p nh·∫≠t: Trangthai = ƒê√£ h·ªßy');
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
                }
            }

            if (vnp_ResponseCode === '00') {
                // Thanh to√°n th√†nh c√¥ng
                const amount = vnp_Amount ? (parseInt(vnp_Amount) / 100).toLocaleString('vi-VN') : '0';
                const payDate = vnp_PayDate ? formatPaymentDate(vnp_PayDate) : 'N/A';

                resultContent.innerHTML = `
                    <div class="result-icon success">‚úì</div>
                    <h1 class="result-title">Thanh to√°n th√†nh c√¥ng!</h1>
                    <p class="result-message">
                        C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n. ƒê∆°n ƒë·∫∑t ph√≤ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.<br>
                        Ch√∫ng t√¥i ƒë√£ g·ª≠i email x√°c nh·∫≠n ƒë·∫øn h√≤m th∆∞ c·ªßa b·∫°n.
                    </p>
                    
                    <div class="result-details">
                        <div class="detail-row">
                            <span class="detail-label">M√£ giao d·ªãch:</span>
                            <span class="detail-value">${vnp_TransactionNo || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">M√£ ƒë∆°n h√†ng:</span>
                            <span class="detail-value">${vnp_TxnRef || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">S·ªë ti·ªÅn:</span>
                            <span class="detail-value">${amount} VNƒê</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Th·ªùi gian:</span>
                            <span class="detail-value">${payDate}</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <a href="my_room.html" class="btn btn-primary">Xem ƒë∆°n ƒë·∫∑t ph√≤ng</a>
                        <a href="home.html" class="btn btn-secondary">V·ªÅ trang ch·ªß</a>
                    </div>
                `;
            } else {
                // Thanh to√°n th·∫•t b·∫°i
                const errorMessage = getErrorMessage(vnp_ResponseCode);

                resultContent.innerHTML = `
                    <div class="result-icon error">‚úó</div>
                    <h1 class="result-title">Thanh to√°n th·∫•t b·∫°i!</h1>
                    <p class="result-message">
                        ${errorMessage}<br>
                        Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá v·ªõi ch√∫ng t√¥i ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.
                    </p>
                    
                    <div class="result-details">
                        <div class="detail-row">
                            <span class="detail-label">M√£ l·ªói:</span>
                            <span class="detail-value">${vnp_ResponseCode || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">M√£ ƒë∆°n h√†ng:</span>
                            <span class="detail-value">${vnp_TxnRef || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <a href="cus_info_booking.html" class="btn btn-primary">Th·ª≠ l·∫°i</a>
                        <a href="home.html" class="btn btn-secondary">V·ªÅ trang ch·ªß</a>
                    </div>
                `;
            }
        });

        function formatPaymentDate(dateStr) {
            // Format: yyyyMMddHHmmss -> dd/MM/yyyy HH:mm:ss
            if (!dateStr || dateStr.length !== 14) return dateStr;

            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const hour = dateStr.substring(8, 10);
            const minute = dateStr.substring(10, 12);
            const second = dateStr.substring(12, 14);

            return `${day}/${month}/${year} ${hour}:${minute}:${second}`;
        }

        function getErrorMessage(code) {
            const errorMessages = {
                '07': 'Giao d·ªãch b·ªã nghi ng·ªù gian l·∫≠n',
                '09': 'Th·∫ª/T√†i kho·∫£n c·ªßa kh√°ch h√†ng ch∆∞a ƒëƒÉng k√Ω d·ªãch v·ª• InternetBanking t·∫°i ng√¢n h√†ng',
                '10': 'Kh√°ch h√†ng x√°c th·ª±c th√¥ng tin th·∫ª/t√†i kho·∫£n kh√¥ng ƒë√∫ng qu√° 3 l·∫ßn',
                '11': 'ƒê√£ h·∫øt h·∫°n ch·ªù thanh to√°n. Xin qu√Ω kh√°ch vui l√≤ng th·ª±c hi·ªán l·∫°i giao d·ªãch',
                '12': 'Th·∫ª/T√†i kho·∫£n c·ªßa kh√°ch h√†ng b·ªã kh√≥a',
                '13': 'Qu√Ω kh√°ch nh·∫≠p sai m·∫≠t kh·∫©u x√°c th·ª±c giao d·ªãch (OTP)',
                '24': 'Kh√°ch h√†ng h·ªßy giao d·ªãch',
                '51': 'T√†i kho·∫£n c·ªßa qu√Ω kh√°ch kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ th·ª±c hi·ªán giao d·ªãch',
                '65': 'T√†i kho·∫£n c·ªßa Qu√Ω kh√°ch ƒë√£ v∆∞·ª£t qu√° h·∫°n m·ª©c giao d·ªãch trong ng√†y',
                '75': 'Ng√¢n h√†ng thanh to√°n ƒëang b·∫£o tr√¨',
                '79': 'KH nh·∫≠p sai m·∫≠t kh·∫©u thanh to√°n qu√° s·ªë l·∫ßn quy ƒë·ªãnh',
                '99': 'L·ªói kh√¥ng x√°c ƒë·ªãnh'
            };

            return errorMessages[code] || 'ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n';
        }
    </script>
</body>

</html>