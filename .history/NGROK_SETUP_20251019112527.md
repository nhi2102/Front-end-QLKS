# ğŸŒ HÆ¯á»šNG DáºªN Cáº¤U HÃŒNH NGROK CHO VNPAY

## Váº¥n Ä‘á»
Khi thanh toÃ¡n VNPay thÃ nh cÃ´ng, nÃ³ redirect vá» `localhost` thay vÃ¬ ngrok URL, khiáº¿n báº¡n khÃ´ng thá»ƒ nháº­n Ä‘Æ°á»£c káº¿t quáº£ thanh toÃ¡n.

## Giáº£i phÃ¡p

### BÆ°á»›c 1: Cháº¡y ngrok
```bash
ngrok http 5500
```
(Thay `5500` báº±ng cá»•ng cá»§a báº¡n náº¿u khÃ¡c)

### BÆ°á»›c 2: Copy ngrok URL
Sau khi cháº¡y ngrok, báº¡n sáº½ tháº¥y output nhÆ°:
```
Forwarding    https://abc123-xyz.ngrok-free.app -> http://localhost:5500
```

Copy URL `https://abc123-xyz.ngrok-free.app`

### BÆ°á»›c 3: Cáº¥u hÃ¬nh Return URL

**CÃ¡ch 1: Sá»­a file `config.js`** (Khuyáº¿n nghá»‹)
```javascript
// Uncomment dÃ²ng nÃ y vÃ  thay YOUR_NGROK_URL
window.RETURN_BASE_URL = 'https://abc123-xyz.ngrok-free.app';
```

**CÃ¡ch 2: Set trá»±c tiáº¿p trong Console trÆ°á»›c khi Ä‘áº·t phÃ²ng**
```javascript
window.RETURN_BASE_URL = 'https://abc123-xyz.ngrok-free.app';
```

### BÆ°á»›c 4: Test
1. VÃ o trang Ä‘áº·t phÃ²ng qua ngrok: `https://abc123-xyz.ngrok-free.app/cus_info_booking.html`
2. Äáº·t phÃ²ng vÃ  chá»n thanh toÃ¡n VNPay
3. Sau khi thanh toÃ¡n (thÃ nh cÃ´ng hoáº·c há»§y), VNPay sáº½ redirect vá»: 
   `https://abc123-xyz.ngrok-free.app/payment-result.html?vnp_ResponseCode=...`
4. Trang `payment-result.html` sáº½ tá»± Ä‘á»™ng cáº­p nháº­t tráº¡ng thÃ¡i Ä‘áº·t phÃ²ng trong database

## LÆ°u Ã½ quan trá»ng

### âš ï¸ Ngrok URL thay Ä‘á»•i má»—i láº§n cháº¡y
- Má»—i láº§n cháº¡y `ngrok http 5500`, báº¡n sáº½ nháº­n Ä‘Æ°á»£c URL má»›i
- Pháº£i cáº­p nháº­t `config.js` má»—i khi URL thay Ä‘á»•i

### ğŸ’¡ Ngrok URL cá»‘ Ä‘á»‹nh (Paid plan)
Náº¿u dÃ¹ng ngrok paid plan, báº¡n cÃ³ thá»ƒ cÃ³ domain cá»‘ Ä‘á»‹nh:
```bash
ngrok http 5500 --domain=your-domain.ngrok-free.app
```

### ğŸ” Debug
Má»Ÿ Console (F12) Ä‘á»ƒ xem:
```javascript
console.log('ğŸŒ Return Base URL:', window.RETURN_BASE_URL);
```

## Flow hoáº¡t Ä‘á»™ng

```
1. KhÃ¡ch Ä‘áº·t phÃ²ng
   â†“
2. Táº¡o booking vá»›i tráº¡ng thÃ¡i "Chá» xÃ¡c nháº­n" + "ChÆ°a thanh toÃ¡n"
   â†“
3. Redirect sang VNPay vá»›i returnUrl = {RETURN_BASE_URL}/payment-result.html
   â†“
4. KhÃ¡ch thanh toÃ¡n trÃªn VNPay
   â†“
5. VNPay redirect vá» {RETURN_BASE_URL}/payment-result.html?vnp_ResponseCode=00
   â†“
6. payment-result.html:
   - Äá»c vnp_ResponseCode
   - Náº¿u '00' â†’ Update DB: "ÄÃ£ thanh toÃ¡n" + "ÄÃ£ Ä‘áº·t"
   - Náº¿u khÃ¡c â†’ Update DB: "ChÆ°a thanh toÃ¡n" + "ÄÃ£ há»§y"
```

## Troubleshooting

### Váº«n redirect vá» localhost?
- Kiá»ƒm tra `window.RETURN_BASE_URL` trong Console
- Äáº£m báº£o `config.js` Ä‘Æ°á»£c load TRÆ¯á»šC `cus_info.js` vÃ  `payment.js`
- Clear cache vÃ  reload láº¡i trang

### VNPay khÃ´ng redirect?
- Kiá»ƒm tra ngrok cÃ³ Ä‘ang cháº¡y khÃ´ng
- Thá»­ access ngrok URL trá»±c tiáº¿p trong browser
- Kiá»ƒm tra firewall/antivirus cÃ³ block ngrok khÃ´ng

### Database khÃ´ng cáº­p nháº­t?
- Má»Ÿ Console trong `payment-result.html`
- Xem log `âœ… ÄÃ£ cáº­p nháº­t Ä‘áº·t phÃ²ng` hoáº·c `âŒ Lá»—i cáº­p nháº­t`
- Kiá»ƒm tra API backend cÃ³ Ä‘ang cháº¡y khÃ´ng
