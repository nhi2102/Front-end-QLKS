<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu√™n M·∫≠t Kh·∫©u</title>
    <link rel="stylesheet" href="account.css">
</head>

<body>
    <div class="glass-container">
        <h2>QU√äN M·∫¨T KH·∫®U</h2>
        <form id="forgotForm">
            <div class="input-group">
                <input type="email" id="email" required>
                <label>Email</label>
            </div>
            <button type="submit" id="resetBtn" class="login-btn">G·ª≠i m·∫≠t kh·∫©u m·ªõi</button>
            <p id="successMessage" style="display:none; color:#4CAF50; margin-top:10px;"></p>
            <p id="errorMessage" style="display:none; color:#f44336; margin-top:10px;"></p>
            <br>
            <div class="register-link">
                Nh·ªõ m·∫≠t kh·∫©u? <a href="login.html">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = "https://localhost:7076/api";

        document.getElementById("forgotForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const email = document.getElementById("email").value.trim();
            const btn = document.getElementById("resetBtn");
            const successMsg = document.getElementById("successMessage");
            const errorMsg = document.getElementById("errorMessage");

            successMsg.style.display = "none";
            errorMsg.style.display = "none";

            // Ki·ªÉm tra email h·ª£p l·ªá
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                showError("Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n!");
                return;
            }
            if (!emailRegex.test(email)) {
                showError("Email kh√¥ng h·ª£p l·ªá!");
                return;
            }

            btn.textContent = "ƒêang g·ª≠i...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/Taikhoans/QuenMatKhau?email=${encodeURIComponent(email)}`, {
                    method: "POST"
                });

                // X·ª≠ l√Ω response d·ª±a tr√™n Content-Type
                let data;
                const contentType = res.headers.get("content-type");

                if (contentType && contentType.includes("application/json")) {
                    data = await res.json();
                } else {
                    // N·∫øu kh√¥ng ph·∫£i JSON, l·∫•y text
                    const textResult = await res.text();
                    console.log("üì° Response text:", textResult);

                    // C·ªë g·∫Øng parse JSON, n·∫øu kh√¥ng ƒë∆∞·ª£c th√¨ t·∫°o object l·ªói
                    try {
                        data = JSON.parse(textResult);
                    } catch {
                        if (textResult.includes("Microsoft.") || textResult.includes("Exception")) {
                            const errorLines = textResult.split('\n');
                            const mainError = errorLines[0] || textResult;
                            data = {
                                success: false,
                                message: `L·ªói h·ªá th·ªëng: ${mainError}\n\nVui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ reset m·∫≠t kh·∫©u.`
                            };
                        } else {
                            data = {
                                success: false,
                                message: textResult || "L·ªói server kh√¥ng x√°c ƒë·ªãnh"
                            };
                        }
                    }
                }

                console.log("üì° K·∫øt qu·∫£ API qu√™n m·∫≠t kh·∫©u:", data);

                if (!res.ok) {
                    throw new Error(data.message || "Kh√¥ng th·ªÉ g·ª≠i m·∫≠t kh·∫©u m·ªõi!");
                }

                showSuccess("‚úÖ " + (data.message || "M·∫≠t kh·∫©u m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email c·ªßa b·∫°n!"));

                // T·ª± ƒë·ªông quay v·ªÅ trang ƒëƒÉng nh·∫≠p sau 3 gi√¢y
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 3000);

            } catch (err) {
                console.error("L·ªói qu√™n m·∫≠t kh·∫©u:", err);

                let errorMessage = err.message || "L·ªói k·∫øt n·ªëi t·ªõi server. Vui l√≤ng th·ª≠ l·∫°i!";

                // X·ª≠ l√Ω c√°c lo·∫°i l·ªói ph·ªï bi·∫øn
                if (errorMessage.includes('Microsoft.') || errorMessage.includes('Exception')) {
                    errorMessage = '‚ùå L·ªói h·ªá th·ªëng khi reset m·∫≠t kh·∫©u\n\n' +
                        'üîß Vui l√≤ng:\n' +
                        '- Ki·ªÉm tra email c√≥ ƒë√∫ng kh√¥ng\n' +
                        '- Li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£\n\n' +
                        'üìß Email h·ªó tr·ª£: support@hotel.com';
                } else if (errorMessage.includes('kh√¥ng t·ªìn t·∫°i') || errorMessage.includes('not found')) {
                    errorMessage = '‚ö†Ô∏è Email n√†y ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω trong h·ªá th·ªëng\n\n' +
                        'Vui l√≤ng:\n' +
                        '- Ki·ªÉm tra l·∫°i email\n' +
                        '- Ho·∫∑c ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi';
                } else if (errorMessage.includes('NetworkError') || errorMessage.includes('fetch')) {
                    errorMessage = 'üåê Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server\n\n' +
                        'Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i!';
                } else if (errorMessage.includes('JSON')) {
                    errorMessage = 'üîß L·ªói h·ªá th·ªëng ph·∫£n h·ªìi\n\n' +
                        'Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá admin!';
                }

                showError(errorMessage);
            } finally {
                btn.textContent = "G·ª≠i m·∫≠t kh·∫©u m·ªõi";
                btn.disabled = false;
            }

            function showError(msg) {
                errorMsg.textContent = msg;
                errorMsg.style.display = "block";
                successMsg.style.display = "none";
            }

            function showSuccess(msg) {
                successMsg.textContent = msg;
                successMsg.style.display = "block";
                errorMsg.style.display = "none";
            }
        });
    </script>
</body>

</html>