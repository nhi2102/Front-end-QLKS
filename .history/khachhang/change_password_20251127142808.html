<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đổi Mật Khẩu</title>
    <link rel="stylesheet" href="../khachhang/css/account.css">
</head>

<body>
    <div class="glass-container">
        <h2>ĐỔI MẬT KHẨU</h2>
        <form id="changePasswordForm">
            <div class="input-group">
                <input type="text" id="emailorsdt" required readonly>
                <label>Email hoặc Số điện thoại</label>
            </div>

            <div class="input-group">
                <input type="password" id="oldPassword" required>
                <label>Mật khẩu cũ</label>
            </div>

            <div class="input-group">
                <input type="password" id="newPassword" required>
                <label>Mật khẩu mới</label>
            </div>

            <div class="input-group">
                <input type="password" id="confirmPassword" required>
                <label>Xác nhận mật khẩu mới</label>
            </div>

            <button type="submit" id="changeBtn" class="login-btn">Đổi mật khẩu</button>

            <p id="successMessage" style="display:none; color:#4CAF50; margin-top:10px;"></p>
            <p id="errorMessage" style="display:none; color:#f44336; margin-top:10px;"></p>

            <br>
            <div class="register-link">
                <a href="../khachhang/home.html">⬅ Quay lại trang chủ</a>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = "https://localhost:7076/api";

        // Tự động lấy email từ localStorage khi trang load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Đang tải thông tin người dùng...');

            const currentUserStr = localStorage.getItem('currentUser');
            console.log('localStorage currentUser:', currentUserStr);

            if (!currentUserStr) {
                alert('Vui lòng đăng nhập để đổi mật khẩu!');
                window.location.href = '../khachhang/login.html';
                return;
            }

            const currentUser = JSON.parse(currentUserStr);
            console.log('Thông tin user:', currentUser);

            const emailInput = document.getElementById('emailorsdt');

            if (currentUser && (currentUser.email || currentUser.sdt)) {
                const userIdentifier = currentUser.email || currentUser.sdt;
                console.log('Đang set email/sdt:', userIdentifier);
                emailInput.value = userIdentifier;
                // Force label to float up
                emailInput.classList.add('has-value');
            } else {
                alert('Không tìm thấy thông tin email/số điện thoại!');
                window.location.href = '../khachhang/login.html';
            }
        });

        document.getElementById("changePasswordForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const emailorsdt = document.getElementById("emailorsdt").value.trim();
            const oldPassword = document.getElementById("oldPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const btn = document.getElementById("changeBtn");
            const successMsg = document.getElementById("successMessage");
            const errorMsg = document.getElementById("errorMessage");

            successMsg.style.display = "none";
            errorMsg.style.display = "none";

            if (!emailorsdt || !oldPassword || !newPassword || !confirmPassword) {
                showError("Vui lòng nhập đầy đủ thông tin!");
                return;
            }

            if (newPassword.length < 8) {
                showError("Mật khẩu mới phải có ít nhất 8 ký tự!");
                return;
            }

            // Chữ cái đầu phải viết hoa
            if (!/^[A-Z]/.test(newPassword)) {
                showError("Chữ cái đầu của mật khẩu mới phải viết hoa!");
                return;
            }

            // Phải có ít nhất 1 chữ thường
            if (!/[a-z]/.test(newPassword)) {
                showError("Mật khẩu mới phải chứa ít nhất 1 chữ thường!");
                return;
            }

            // Phải có ít nhất 1 số
            if (!/\d/.test(newPassword)) {
                showError("Mật khẩu mới phải chứa ít nhất 1 số!");
                return;
            }

            // Phải có ít nhất 1 ký tự đặc biệt
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                showError("Mật khẩu mới phải chứa ít nhất 1 ký tự đặc biệt!");
                return;
            }

            // Không được chứa khoảng trắng
            if (/\s/.test(newPassword)) {
                showError("Mật khẩu mới không được chứa khoảng trắng!");
                return;
            }


            if (newPassword !== confirmPassword) {
                showError("Mật khẩu xác nhận không khớp!");
                return;
            }

            btn.textContent = "Đang xử lý...";
            btn.disabled = true;

            try {
                const res = await fetch(
                    `${API_BASE}/Taikhoans/DoiMatKhau?emailorsdt=${encodeURIComponent(emailorsdt)}&matkhaucu=${encodeURIComponent(oldPassword)}&matkhaumoi=${encodeURIComponent(newPassword)}`, {
                        method: "POST"
                    }
                );

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || "Không thể đổi mật khẩu!");
                }

                showSuccess(" " + (data.message || "Đổi mật khẩu thành công!"));
                setTimeout(() => window.location.href = "../khachhang/login.html", 3000);

            } catch (err) {
                console.error("Lỗi đổi mật khẩu:", err);
                showError(err.message || "Lỗi kết nối tới server. Vui lòng thử lại!");
            } finally {
                btn.textContent = "Đổi mật khẩu";
                btn.disabled = false;
            }

            function showError(msg) {
                errorMsg.textContent = msg;
                errorMsg.style.display = "block";
                successMsg.style.display = "none";
            }

            function showSuccess(msg) {
                successMsg.textContent = msg;
                successMsg.style.display = "block";
                errorMsg.style.display = "none";
            }
        });
    </script>
</body>

</html>